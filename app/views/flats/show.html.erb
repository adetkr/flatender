<!-- Not Connected Modal -->
<div class="modal fade" id="NotConnectedModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" >Connexion</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Vous devez être connecté pour pouvoir liker un appartement
      </div>

      <div class="modal-footer">
        <%= link_to "Se connecter", new_user_session_path, class: "btn btn-secondary" %>
        <%= link_to "S'inscrire", new_user_registration_path, class: "btn btn-primary" %>
      </div>
    </div>
  </div>
</div>
<!-- Matches Modal -->
<div class="modal fade" id="MatchModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nouveau Match!</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Super ! Vous venez d'avoir un match avec l'apprtement de <span id="matchName"> </span> !
          N'hésitez pas à engager la conversation!
        </div>
      <div class="modal-footer">
        <%= link_to "Let's Chat", '/' , class: "btn btn-primary" , id: "matchpath" %>

        <button type="button" class="btn btn-secondary" data-dismiss="modal">Maybe Later</button>

      </div>
    </div>
  </div>
</div>





<section id="flat" class="p-5">
  <div class="container-fluid">
    <p class="text-primary h6"><%= @flat.user.university %></p>
    <h1 class="pb-3 h2"><%= @flat.title %>
    <% if @flat.user == current_user  %>
      <%= link_to edit_flat_path(@flat.id) , class: "btn btn-primary" do %>
      <i class="far fa-edit"></i>
      <% end %>
    <% end %>
    </h1>
    <div class="row">
      <div class="col-7">
        <div class="lightgallery mb-5">
          <% if @flat.photos.attached? %>
            <div class=" mb-2 pr-2 main-img">
              <a href="<%= cl_image_path @flat.photos.first.key, height: 550, width: 1200, crop: :fill %>">
                <%= cl_image_tag @flat.photos.first.key, height: 500, width: 1200, crop: :fill, class: "img-fluid" %>
              </a>
            </div>
          <% end %>

          <% if  @flat.photos.length >= 2 %>
          <div class="mb-2 d-flex thumb-img">
            <% @flat.photos[1..-1].each do |photo| %>
              <a href="<%= cl_image_path photo.key, height: 500, width: 1200, crop: :fill  %>">
                <%= cl_image_tag photo.key, height: 180, width: 300, crop: :fill, class: "img-fluid pr-2" %>
              </a>
            <% end %>
          </div>
          <% end %>
          <% if !@flat.photos.attached? %>
            <%= image_tag "flat-default.jpg", height: 500, width: 1200, crop: :fill, class: "img-fluid rounded-lg" %>
          <% end %>
        </div>

        <!-- presentation -->
        <div id="presentation" class="bg-white-smoke rounded-lg p-4 mb-5 border">
          <h3 class="mb-2 h5"><%= @flat.surface %>m<sup>2</sup> - <%= @flat.rooms %> rooms</h3>
          <p><%= @flat.presentation %></p>
        </div>

        <!--  Equipment -->
        <div id="equipment" class="bg-white-smoke rounded-lg p-4 mb-5 border">
          <h3 class="mb-4 h5">Equipment</h3>
          <div class="d-flex flex-wrap">
            <% @flat.equipments.each do |equipment| %>
              <div class="equipment col-4 pl-0 mb-3 <%= equipment.name %>">
                <%= equipment.name %>
              </div>
            <% end %>
          </div>

           <% if @flat.user == current_user  %>
              <h5>Ajouter une equipement</h5>
              <%= simple_form_for([@flat,@flat_equipment]) do |f| %>
                <%= f.association :equipment %>
                <%= f.submit "ajouter une equipment" %>
              <% end %>
           <% end %>
        </div>

        <!--  Map -->
        <div id="map" class="rounded-lg"
          style="width: 100%; height: 350px;"
          data-markers="<%= @markers.to_json %>"
          data-mapbox-api-key="<%= ENV['MAPBOX_API_KEY'] %>">
        </div>
     </div>


      <!--  User presentation -->
      <div class="pl-5 col-5" data-controller="like">
        <div class="col-4 bg-white-smoke rounded-lg p-4 mb-5 mr-3 border position-fixed">
           <div id="info" class="d-flex">
            <div>
                <% if @flat.user.photo.attached? %>
                  <%= cl_image_tag @flat.user.photo.key, class: "avatar mr-2 rounded-circle" %>
                <% else %>
                  <%= image_tag  "https://kitt.lewagon.com/placeholder/users/random", class: "avatar mr-2" %>
                <% end %>
           </div>
            <div class="flex-grow-1">
              Proposed by:
              <br>
              <span class="text-primary font-weight-normal"><%= @flat.user.name %></span>
            </div>
           </div>
           <hr>
           <div>
             <p>
               <%= @flat.user.presentation %>
             </p>
             <p>
               <span class="text-primary font-weight-bold">Availability of the apartment</span>
               <br>
               <i class="fas fa-calendar-alt text-secondary mr-1"></i> Septembre 2021 - Aout 2022 (Date flexible)
             </p>
           </div>
           <hr class="mt-5">
           <div class="d-flex justify-content-between align-items-center">
            <div id="like">
              <% if  current_user and @flat.user != current_user %>
                <% like = Like.find_by(user_id: current_user.id, flat_id: @flat.id) %>
                <% if   Like.where(user_id: current_user.id, flat_id: @flat.id).count != 0 %>
                  <button id = "like" data-like-id = "<%= like.id %>"   data-user-id = "<%= current_user.id %>" data-flat-id = "<%= @flat.id %>" class="btn-style-01 text-uppercase py-2 px-5 rounded-lg" disabled=true > Liked <i class="fas fa-heart ml-1"></i></button>
                <% else %>
                  <a id = "match-modal" class="hidden">  </a>
                  <button id = "like" data-user-id = "<%= current_user.id %>" data-flat-id = "<%= @flat.id %>" class="btn-style-01 text-uppercase py-2 px-5 rounded-lg" data-action="click->like#likeFlat"> Like <i class="fas fa-star ml-1"></i></button>
                <% end %>
              <% else %>
                <% if @flat.user != current_user %>
                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#NotConnectedModal"> Liker <i class="fas fa-star ml-1"></i> </button>

                <% end %>
              <% end %>
            </div>
            <div id="price">
              <span class="h4"><%= @flat.rent %> €</span><span>/mo</span>
            </div>
           </div>
        </div>
      </div>
      </div>
      <!--  /User presentation -->
    </div>
  </div>
</section>
